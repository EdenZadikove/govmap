
<html style='width:100%; height:100%;'>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>



.v-data-table__mobile-row__header {

width: 49.5%;	
text-align: right;
  direction: rtl;

}

.v-data-table__mobile-row__cell {
  width: 49.5%;
  text-align: right;
  direction: rtl;
  }

  





 .custom-loader {
    animation: loader 1s infinite;
    display: flex;
  }
  @-moz-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }
  @-webkit-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }
  @-o-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }
  @keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 600px) {
    #myTitle {
      display: none;
    }
	#myMenu{
      display: none;
    }
  }

   @media (min-width: 600px) {
    #myTitleMobile {
      display: none;
    }
	#myMenuMobile{
      display: none;
    }
  }




  
.list__tile__title {
    text-align: right;
}

.toolbar__title {
    margin-right: 16px;
}

.input-group--text-field label {
    position: absolute;
    top: 18px;
    right: 0;
}

.input-group label {
    text-align: right;
    -webkit-transform-origin: top right;
    transform-origin: top right;
}
.input-group.input-group--selection-controls label{
    right: 32px;
    left: auto;
}
.input-group.input-group--selection-controls .icon--selection-control {
    left: auto;
    right: 0;
}
.input-group--selection-controls__ripple {
    -webkit-transform: translate3d(12px,-52%,0);
    transform: translate3d(12px,-52%,0);
    left: auto;
    right: 0;
}

.mot_watermark
{
    position:fixed;
    right: 150px!important;
    bottom: 45px!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}
.watermark
{
    position:fixed;
    right: 100px!important;
    bottom: 45px!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.select_map_watermark
{
    position: absolute;
    right: 0%!important;
    bottom: 50%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.add_layer_watermark
{
    position: absolute;
    right: 0%!important;
    bottom: 40%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.measure_watermark
{
    position: absolute;
    right: 0%!important;
    bottom: 30%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}
.info_watermark
{
    position: absolute;
    left: 0%!important;
    bottom: 50%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.search_watermark
{
    position: absolute;
    left: 0%!important;
    bottom: 40%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.filter_watermark
{
    position: absolute;
    left: 0%!important;
    bottom: 30%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}

.share_watermark
{
    position: absolute;
    left: 0%!important;
    bottom: 20%!important;
    background-color: transparent;
    border: none;
    z-index: 1;
    font-family: mapiregular;
    display: inline-block;
}


#create .v-speed-dial {
    position: absolute;
  }

  #create .v-btn--floating {
    position: relative;
  }


    </style>

    <head>
        <title>מוקדי קידום קהילתי</title>
        <link rel= 'stylesheet' href= 'https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons'> 
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">   
        <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
        <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" ></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script src="https://unpkg.com/terraformer@1.0.8"></script>
        <script src="https://unpkg.com/terraformer-wkt-parser@1.1.2"></script>    
    </head>

    <body style='width:100%; height:95%;' scrolling='no' dir="rtl">
        <div id="isolation_app">
            <v-app>
                <form style='height: 5%;' scrolling='no'> 

                    <v-app-bar style="text-align: center; max-height: 48px;"
                    color="indigo"
                    dense
                    dark
                    id="myTitle">

                        <div class="text-right" style="width:25%; text-align:right;" id="mosad">
                            <v-autocomplete
                            clearable
                            v-model="select"
                            :loading="loading"
                            :items="items"
                            :search-input.sync="search"
                            cache-items
                            class="mx-4"
                            flat
                            hide-no-data
                            hide-details
                            placeholder="שם מוסד"
                            solo-inverted
                            @change='zoom'
                            ></v-autocomplete>
                        </div>

                        <div class="text-right" style="width:25%; text-align:right;" id="setl">
                            <v-autocomplete
                            clearable
                            v-model="s_select"
                            :loading="s_loading"
                            :items="s_items"
                            :search-input.sync="s_search"
                            cache-items
                            class="mx-4"
                            flat
                            hide-no-data
                            hide-details
                            placeholder="שם ישוב"
                            solo-inverted
                            @change='zoom'
                            ></v-autocomplete>
                        </div>

                        <div class="text-right" style="width:25%; text-align:right;"  id="layer">
                            <v-autocomplete :items="l_items" placeholder="שכבה" clearable flat solo-inverted hide-details hide-no-data v-model="l_select" @change='zoom'
                            :loading="l_loading"
                            :search-input.sync="l_search"
                            item-text="name"
                            cache-items>
                                <template v-slot:item="{ item }">
                                <img :src="item.image">
                                <span>{{ item.name }}</span>
                                </template>
                            </v-autocomplete>
                        </div>

            
                        <v-divider vertical></v-divider>
        
                        <v-spacer></v-spacer>
                        <v-toolbar-title class="white--text" style="text-align: center; max-height: 48px;">מוקדי קידום קהילתי</v-toolbar-title>
                        <v-spacer></v-spacer>

                        <v-divider vertical></v-divider>

                        <div class="text-right" style="width:25%; text-align:right; padding-right: 30px; position: relative; margin: 0 auto;" > 
                            <v-dialog right
                            v-model="dialog"
                            width="300">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn tile block outlined color="white"
                                        v-bind="attrs"
                                        v-on="on">
                                        סוג חיפוש
                                    </v-btn>
                                </template>
                            </v-dialog>
                        </div>
        
                    </v-app-bar>

                    <v-toolbar dark color="indigo" id="myTitleMobile" style='height: 50px;'>
                        <v-row style='height: 55px;'>
                            <div class="text-right" style="width:75%; text-align:right;" id="mosad_mobile">
                                <v-autocomplete
                                clearable
                                v-model="select"
                                :loading="loading_mobile"
                                :items="items"
                                :search-input.sync="search_mobile"
                                cache-items
                                class="mx-4"
                                flat
                                hide-no-data
                                hide-details
                                placeholder="חיפוש לפי שם מוסד"
                                solo-inverted
                                @change='zoom'
                                >
                                </v-autocomplete>
                            </div>

                            <div div class="text-right" style="width:75%; text-align:right;" id="setl_mobile">
                                <v-autocomplete
                                clearable
                                v-model="s_select"
                                :loading="s_loading_mobile"
                                :items="s_items"
                                :search-input.sync="s_search_mobile"
                                cache-items
                                class="mx-4"
                                flat
                                hide-no-data
                                hide-details
                                placeholder="חיפוש לפי שם ישוב"
                                solo-inverted
                                @change='zoom'>
                                </v-autocomplete>
                            </div>

                            <div div class="text-right" style="width:75%; text-align:right;" id="layer_mobile">
                                <v-autocomplete :items="l_items" placeholder="חיפוש לפי שם שכבה" clearable flat solo-inverted hide-details hide-no-data v-model="l_select" @change='zoom'
                                :loading="l_loading_mobile"
                                :search-input.sync="l_search_mobile"
                                item-text="name"
                                cache-items>
                                    <template v-slot:item="{ item }">
                                        <img :src="item.image">
                                        <span>{{ item.name }}</span>
                                    </template>
                                </v-autocomplete>
                            </div>

                            
                            <div div class="text-right" style="width:25%; text-align:right; margin-top: 6px;" > 
                                <v-dialog right
                                v-model="dialog"
                                width="300">
                                <template v-slot:activator="{ on, attrs }">
                                    <v-btn tile block outlined color="white" v-bind="attrs" v-on="on">
                                        סוג חיפוש
                                    </v-btn>
                                </template>
                        
                                <v-card class="d-inline-block">
                                    <v-radio-group v-model="radios" :mandatory="false">  
                                        <v-radio label="חיפוש לפי שם ישוב" color="indigo" @change="bySetl" value="radio-2"></v-radio>
                                        <v-radio label="חיפוש לפי שם מוסד"  color="indigo" @change="byName" value="radio-1"></v-radio>
                                        <v-radio label="חיפוש לפי שם שכבה" color="indigo" @change="byLayer" value="radio-3"></v-radio>
                                    </v-radio-group>
                                </v-card>

                                </v-dialog>
                            </div>      
                        </v-row>
                    </v-toolbar>
                </form>
            
                <form name="form" style='height: 100%;' scrolling='no'> 
                        <div id="map_div" style="width: 100%; height: 100%; float:left">
                        </div> 			
                </form>

                <div class="text-center">
                    <v-bottom-sheet v-model="sheet">
                      <template v-slot:activator="{ on }">
                        <v-btn
                          block 
                          color="#1A237E"
                          dark
                          dense
                          v-on="on"
                          @click="sheet = false"
                        >
            
                        <v-badge
                        color="green"
                        :content="desserts.length"
                        :value="desserts.length"
                      >
                      הצגת טבלה
                      </v-badge>
                        </v-btn>
                      </template>
            
                        <v-layout id="table-v-layout" column style="max-height: 60vh">       
                              <v-flex style="overflow: auto;">
                                <v-card style="bottom: 0; ">
                                <v-card-title>
            
                                    <v-divider vertical></v-divider>
            
            
                                        <p class="text-subtitle-1" style="width:auto; margin-top: 30px; margin-right: 20px; margin-left: 10px;">
                                            <v-badge left
                                            color="green"
                                            :content="desserts.length"
                                            :value="desserts.length">קידום קהילתי
                                        </v-badge></p>
                                    
            
                                    <v-divider vertical></v-divider>
            
                                    <v-text-field
                                      v-model="tsearch"
                                      append-icon="mdi-magnify"
                                      placeholder="חיפוש בתוצאות"
                                      single-line
                                      hide-details
                                      style="width: 30%; margin-left: 10px;  margin-right: 10px;"
                                    ></v-text-field>
                                
            
                                    <v-divider vertical></v-divider>
            
                                    
            
                                    <v-tooltip right>
                                        <template v-slot:activator="{ on }">
                                            <v-btn class="ma-2" color="green" dark style="width: 5%;" v-on="on"  @click="fnExcelReport">
                                                <v-icon dark>mdi-file-excel</v-icon>
                                            </v-btn>
                                        </template>
                                        <span>יצוא לקובץ אקסל</span>
                                    </v-tooltip>
                                    <v-divider vertical></v-divider>
            
                                  </v-card-title>   
            
                                <v-data-table id="mytable"
                                :headers="headers"
                                :items="desserts"
                                :height="height"
                                item-key="ID"
                                :search="tsearch"
                                class="elevation-1"
                                fixed-header
                                >
            
            
            
                                <template v-slot:item.action="{ item }">
                                    <v-icon
                                      color="blue"
                                      @click="zoomItem(item)"
                                    >
                                    mdi-map-marker-radius
                                    </v-icon>
                                  </template>
                
                                
                                </v-data-table>
                                </v-card>
                            </v-flex>
                        </v-layout>
                    </v-bottom-sheet>
                </div>
    
    
    
            
    
    
            </v-app>
        </div>
        
        
    <script>
    
            var s_wkts_layer = [];
            var s_names_layer = [];
            var bubbleHTMLParameters_all_layer = [];
            var s_symbols_layer = [];

                
            function ClearUserPoints(){

                var bubbleContent = "";
                var data = {  
                    wkts: [], 
                    showBubble: true, 
                    names: [],  
                    geometryType: govmap.drawType.Point,  
                    defaultSymbol:  
                    {  
                        url:'https://govmap.gov.il/sites/O1.png',  
                        width:20,  
                        height:20  
                    },   
                    symbols: [],  
                    clearExisting: true,  
                    data: {  
                            tooltips: [],  
                            headers: [],
                            bubbleHTML: bubbleContent,
                            bubbleHTMLParameters:[]
                        }  
                };  
                        
                govmap.displayGeometries(data).then(function (response)  
                {  
                //console.log(response.data);
                }); 

            }


            function showLayers()
            {
                var data = {  
                            wkts: s_wkts,  
                            names: s_names,  
                            showBubble: true,
                            geometryType: govmap.drawType.Point,  
                            defaultSymbol:  
                            {  
                                url: url + '/icons/brown.png',  
                                width:20,  
                                height:20  
                            },   
                            symbols: s_symbols,  
                            clearExisting: true,  
                            data: {  
                                    tooltips: s_names,  
                                    headers: s_names,
                                    bubbleHTML: "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div>{0}</div><div>{1}</div><div>{3}</div></div>",
                                    bubbleHTMLParameters:bubbleHTMLParameters_all
                                }  
                            };


                            govmap.displayGeometries(data).then(function (response)  
                            {  
                                console.log(response);
                            });
            }

            function filterLayer(layer_name)
            {
                ClearUserPoints();


                appVue.l_search = layer_name;

                s_wkts_layer = [];
                s_names_layer = [];
                bubbleHTMLParameters_all_layer = [];
                s_symbols_layer = [];

                console.log(layer_name);
                var s_features = kidum_data.filter(function(f) {
                                return f.LAYER == layer_name;		
                });
                for (i=0; i < s_features.length; i++)
                {
                    if (s_features[i].X != "" && s_features[i].Y != "")
                    {
                        if (layer_name == "הגמילה הפיזית מסמים")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([

                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />" + "פקס: " + s_features[i].FAX
                            + "<br />" + "מייל: " + s_features[i].MAIL1
                            + "<br />" + "מייל: " + s_features[i].MAIL2
                            + "<br />" + "מספר טלפון: " + s_features[i].PHONE  
                            , "הערות: " + s_features[i].REMARKS]);
                            symbol_url =url + '/icons/blue.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "טיפול המשך בנפגעי סמים")
                        {
                            console.log("טיפול המשך בנפגעי סמים");
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "מחוז: " + s_features[i].MACHOZ
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER
                            + "<br />"  + "טלפון: " + s_features[i].PHONE
                            ,"אוכלוסיית יעד: " + s_features[i].POP_TYPE ])
                            symbol_url =url + '/icons/red.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "מסלול תרופתי לטיפול ממושך")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />"  + "מחוז: " + s_features[i].MACHOZ
                            + "<br />"  + "מרפאה: " + s_features[i].CLINIC
                            + "<br />"  + "בית מרקחת: " + s_features[i].PHARM
                            + "<br />"  + "רופא/ה: " + s_features[i].DOCTOR
                            + "<br />"  + "רוקח/ת: " + s_features[i].PHARMASIST
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER
                            + "<br />" + "פקס: " + s_features[i].FAX
                            + "<br />"  + "טלפון: " + s_features[i].PHONE,
                            "מייל: " + s_features[i].MAIL1])
                            symbol_url =url + '/icons/green.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "טיפול גמילה אמבולטורי מהתמכרות למשככי כאבים")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />"  + "מרפאה: " + s_features[i].CLINIC
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER
                            + "<br />"  + "טלפון: " + s_features[i].PHONE
                            + "<br />"  + "אוכלוסיית יעד: " + s_features[i].POP_TYPE
                            , "הערות: " + s_features[i].REMARKS]);
                            symbol_url =url + '/icons/orange.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "טיפול בנפגעי אלכוהול")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }

                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER
                            + "<br />"  + "טלפון: " + s_features[i].PHONE
                            + "<br />" + "פקס: " + s_features[i].FAX
                            , "הערות: " + s_features[i].REMARKS]);
                            symbol_url =url + '/icons/ocean.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "אוכלוסיות מיוחדות")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null && s_features[i].TYPE != s_features[i].NAME)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  +"תת סוג מוסד: " + s_features[i].SUB_TYPE
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "מחוז: " + s_features[i].MACHOZ
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER
                            + "<br />"  + "שעות פתיחה: " + s_features[i].OPENING_TIME
                            + "<br />"  + "טלפון: " + s_features[i].PHONE
                            + "<br />" + "פקס: " + s_features[i].FAX
                            , "הערות: " + s_features[i].REMARKS]);
                            symbol_url =url + '/icons/light blue.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });
                        }
                        if (layer_name == "נושאים שונים")
                        {
                            s_wkts_layer.push("POINT(("+s_features[i].X+" "+s_features[i].Y+"))");
                            if (s_features[i].NAME != "" && s_features[i].NAME != null)
                            {
                                s_names_layer.push(s_features[i].NAME);
                            }
                            bubbleHTMLParameters_all_layer.push([
                            "סוג המוסד: " + s_features[i].TYPE
                            + "<br />"  +"שם ישוב: " + s_features[i].SETL_NAME
                            + "<br />"  + "תחום: " + s_features[i].LAYER
                            + "<br />"  + "מעבדה: " + s_features[i].LAB
                            + "<br />"  + "כתובת: " + s_features[i].ADDR
                            + "<br />"  + "טלפון: " + s_features[i].PHONE
                            + "<br />"  + "טלפון נוסף: " + s_features[i].PHONE2
                            + "<br />" + "פקס: " + s_features[i].FAX
                            + "<br />"  + "מנהל/ת: " + s_features[i].MANAGER                       
                            , "מייל: " + s_features[i].MAIL]);
                            symbol_url =url + '/icons/gold.png'
                            s_symbols_layer.push({url:symbol_url, width:30,  height:30  });

                        }
                    }
                }


                var data = {  
                wkts: s_wkts_layer,  
                names: s_names_layer,  
                showBubble: true,
                geometryType: govmap.drawType.Point,  
                defaultSymbol:  
                {  
                    url: url + '/icons/brown.png',  
                    width:20,  
                    height:20  
                },   
                symbols: s_symbols_layer,  
                clearExisting: true,  
                data: {  
                        tooltips: s_names_layer,  
                        headers: s_names_layer,
                        bubbleHTML: "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div>{0}</div><div>{1}</div><div>{3}</div></div>",
                        bubbleHTMLParameters:bubbleHTMLParameters_all_layer
                    }  
                };


                govmap.displayGeometries(data).then(function (response)  
                {  
                    console.log(response);
                });

            }
    
    
    
            function isInArray(value, array) {
                return array.indexOf(value) > -1;
            }
    
            function getDates(startDate, stopDate) {
                var dateArray = new Array();
                var currentDate = startDate;
                while (currentDate <= stopDate) {
                    dateArray.push(new Date (currentDate));
                    currentDate = currentDate.addDays(1);
                }
                return dateArray;
            }

            var lo_el;
            function getHeight()
            {
                var height =  $(document).height()/2.7;
                if (isMobile())
                {
                    console.log("mobile");
                    height =  $(document).height() / 1.8;
                    lo_el = document.getElementById("table-v-layout");
                    lo_el.style.maxHeight = "90vh";

                }
                return height;
            }

            function isMobile() {
                var match = window.matchMedia || window.msMatchMedia;
                if(match) {
                    var mq = match("(pointer:coarse)");
                    return mq.matches;
                }
                return false;
            }

            function getNum(val) {
                if (isNaN(val)) {
                    return 0;
                }
                return val;
            }
    
        
    
           
    
            var intersect_res;
    
    
            var url = 'https://yovavsanders.github.io/govmap/KidumKehilati';
            var setl_url = url + "/data/SETL_AREA_kidum.geojson";
            var setlnames = [];
    

            var kidum_data = [];
            var setl_data;
            var s_wkts = [];
            var s_names = [];
            var s_symbols = [];
            var bubbleHTMLParameters_all = [];

    
                Number.prototype.between = function(a, b) {
                var min = Math.min.apply(Math, [a, b]),
                    max = Math.max.apply(Math, [a, b]);
                    return this >= min && this < max;
                };
    
    
    
            var names = [];
    
            //var my_token = "0fff9694-a045-4ede-b997-ee9927b0d56c";//govmap
            var my_token ='aafedfe5-8dfa-4fd5-9af9-8b95759447bd'; // my github
            //var my_token = "5a4b8472-b95b-4687-8179-0ccb621c7990";//localhost
            $(document).ready(function ()
            {
    
                govmap.createMap('map_div', {
                    token: my_token,
                    visibleLayers: [],
                    layers:[], 
                    layersMode: 4, 
                    showXY: true,
                    level: 1,
                    center: {x: 186000, y: 658000},
                    identifyOnClick: true
                });

                // get all
                var kidum_json = url + "/data/KidumKehilati.json";
                $.ajax({
                    dataType: 'json',
                    beforeSend : function() {


                        $.get(setl_url).then(function (data) {
                            console.log(data);
                            setl_data = data.features;


                            
                            setlnames = [];
                            for (i = 0; i < setl_data.length; i++)
                            {
                                setlnames.push(setl_data[i].properties.SETL_NAME)
                            }
                            setlnames.sort();
                            appVue.s_items = setlnames;
                        });
                        console.log('Before Ajax Request Starts !!');
                    },
                    success: function(data) {
                            //console.log(iso_data);
                            kidum_data = data;
                            console.log(kidum_data);
                            for (i=0; i < kidum_data.length; i++)
                            {
                                kidum_data[i].ID = i;
                                if (kidum_data[i].X != "" && kidum_data[i].Y != "")
                                {

                                    layer = kidum_data[i].LAYER;
                                    if (layer == "הגמילה הפיזית מסמים")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([

                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />" + "פקס: " + kidum_data[i].FAX
                                        + "<br />" + "מייל: " + kidum_data[i].MAIL1
                                        + "<br />" + "מייל: " + kidum_data[i].MAIL2
                                        + "<br />" + "מספר טלפון: " + kidum_data[i].PHONE  
                                        , "הערות: " + kidum_data[i].REMARKS]);
                                        symbol_url =url + '/icons/blue.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "טיפול המשך בנפגעי סמים")
                                    {
                                        console.log("טיפול המשך בנפגעי סמים");
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].SETL_NAME + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].SETL_NAME + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "מחוז: " + kidum_data[i].MACHOZ
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE
                                        ,"אוכלוסיית יעד: " + kidum_data[i].POP_TYPE ])
                                        symbol_url =url + '/icons/red.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "מסלול תרופתי לטיפול ממושך")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                            

                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />"  + "מחוז: " + kidum_data[i].MACHOZ
                                        + "<br />"  + "מרפאה: " + kidum_data[i].CLINIC
                                        + "<br />"  + "בית מרקחת: " + kidum_data[i].PHARM
                                        + "<br />"  + "רופא/ה: " + kidum_data[i].DOCTOR
                                        + "<br />"  + "רוקח/ת: " + kidum_data[i].PHARMASIST
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER
                                        + "<br />" + "פקס: " + kidum_data[i].FAX
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE,
                                        "מייל: " + kidum_data[i].MAIL1])
                                        symbol_url =url + '/icons/green.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "טיפול גמילה אמבולטורי מהתמכרות למשככי כאבים")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE  + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />"  + "מרפאה: " + kidum_data[i].CLINIC
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE
                                        + "<br />"  + "אוכלוסיית יעד: " + kidum_data[i].POP_TYPE
                                        , "הערות: " + kidum_data[i].REMARKS]);
                                        symbol_url =url + '/icons/orange.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "טיפול בנפגעי אלכוהול")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE  + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE
                                        + "<br />" + "פקס: " + kidum_data[i].FAX
                                        , "הערות: " + kidum_data[i].REMARKS]);
                                        symbol_url =url + '/icons/ocean.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "אוכלוסיות מיוחדות")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null && kidum_data[i].TYPE != kidum_data[i].NAME)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE  + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  +"תת סוג מוסד: " + kidum_data[i].SUB_TYPE
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "מחוז: " + kidum_data[i].MACHOZ
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER
                                        + "<br />"  + "שעות פתיחה: " + kidum_data[i].OPENING_TIME
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE
                                        + "<br />" + "פקס: " + kidum_data[i].FAX
                                        , "הערות: " + kidum_data[i].REMARKS]);
                                        symbol_url =url + '/icons/light blue.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });
                                    }
                                    if (layer == "נושאים שונים")
                                    {
                                        s_wkts.push("POINT(("+kidum_data[i].X+" "+kidum_data[i].Y+"))");
                                        if (kidum_data[i].NAME != "" && kidum_data[i].NAME != null)
                                        {
                                            s_names.push(kidum_data[i].NAME);
                                        }
                                        else{
                                            s_names.push(kidum_data[i].LAYER + " " + kidum_data[i].TYPE  + " " + i);
                                            kidum_data[i].NAME = kidum_data[i].LAYER + " " + kidum_data[i].TYPE + " " + i;
                                        }
                                        bubbleHTMLParameters_all.push([
                                        "סוג המוסד: " + kidum_data[i].TYPE
                                        + "<br />"  +"שם ישוב: " + kidum_data[i].SETL_NAME
                                        + "<br />"  + "תחום: " + kidum_data[i].LAYER
                                        + "<br />"  + "מעבדה: " + kidum_data[i].LAB
                                        + "<br />"  + "כתובת: " + kidum_data[i].ADDR
                                        + "<br />"  + "טלפון: " + kidum_data[i].PHONE
                                        + "<br />"  + "טלפון נוסף: " + kidum_data[i].PHONE2
                                        + "<br />" + "פקס: " + kidum_data[i].FAX
                                        + "<br />"  + "מנהל/ת: " + kidum_data[i].MANAGER                       
                                        , "מייל: " + kidum_data[i].MAIL]);
                                        symbol_url =url + '/icons/gold.png'
                                        s_symbols.push({url:symbol_url, width:30,  height:30  });

                                    }
                                    if (!isInArray(s_names[s_names.length - 1], names))
                                    {
                                        names.push(s_names[s_names.length - 1]);
                                    }
                                }
                            }


                            var data = {  
                            wkts: s_wkts,  
                            names: s_names,  
                            showBubble: true,
                            geometryType: govmap.drawType.Point,  
                            defaultSymbol:  
                            {  
                                url: url + '/icons/brown.png',  
                                width:20,  
                                height:20  
                            },   
                            symbols: s_symbols,  
                            clearExisting: false,  
                            data: {  
                                    tooltips: s_names,  
                                    headers: s_names,
                                    bubbleHTML: "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div>{0}</div><div>{1}</div><div>{3}</div></div>",
                                    bubbleHTMLParameters:bubbleHTMLParameters_all
                                }  
                            };


                            govmap.displayGeometries(data).then(function (response)  
                            {  
                                console.log(response);
                            });

                            names.sort();
                            appVue.items = names;


                            
    
    
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        alert("Error occurred: " + errorThrown);
                    },
                    url: kidum_json
                });





                o = document.getElementById("mosad");
                o.hidden = true;
                om = document.getElementById("mosad_mobile");
                om.hidden = true;

                l = document.getElementById("layer");
                l.hidden = true;
                lm = document.getElementById("layer_mobile");
                lm.hidden = true;

            });
    
            
        var appVue = new Vue({
            el:"#isolation_app",
            vuetify: new Vuetify(),
            data () {
                return {
   

                    radios: 'radio-2',
                    checkbox: true,
                    dialog: false,

                    height: getHeight(),
                


                    loading: false,
                    items: [],
                    search: "",
                    search_mobile: null,
                    loading_mobile: null,
                    select: null,
                    select_mobile: null,

                    s_loading: false,
                    s_items: [],
                    s_search: null,
                    s_search_mobile: null,
                    s_loading_mobile: null,
                    s_select: null,
                    s_select_mobile: null,

                    l_loading: false,
                    // l_items: [                   "הגמילה הפיזית מסמים",
                    //     "טיפול המשך בנפגעי סמים",
                    //     "מסלול תרופתי לטיפול ממושך",
                    //     "טיפול גמילה אמבולטורי מהתמכרות למשככי כאבים",
                    //     "טיפול בנפגעי אלכוהול",
                    //     "אוכלוסיות מיוחדות",
                    //     "נושאים שונים"],

                        l_items: [
                            { name: "הגמילה הפיזית מסמים", image: url + '/icons/blue.png'},
                            { name: "טיפול המשך בנפגעי סמים", image: url + '/icons/red.png'},
                            { name: "מסלול תרופתי לטיפול ממושך", image: url + '/icons/green.png'},
                            { name: "טיפול גמילה אמבולטורי מהתמכרות למשככי כאבים", image: url + '/icons/orange.png'},
                            {name: "טיפול בנפגעי אלכוהול", image: url + '/icons/ocean.png'},
                            {name: "אוכלוסיות מיוחדות", image: url + '/icons/light blue.png'},
                            {name: "נושאים שונים", image: url + '/icons/gold.png'},

                        ],


                    l_search: null,
                    l_search_mobile: null,
                    l_loading_mobile: null,
                    l_select: null,
                    l_select_mobile: null,

                    setl_names: [],






                    sheet: false,
                    headers: [
                    { text: 'מספר', value: 'ID' },
                    {
                        text: 'שם המוסד',
                        align: 'right',
                        value: 'NAME',
                    },
                    { text: 'תחום', value: 'LAYER' },
                    { text: 'סוג מתחם', value: 'TYPE' },
                    { text: 'כתובת', value: 'ADDR' },
                    { text: 'מנהל/ת', value: 'MANAGER' },
                    { text: 'טלפון', value: 'PHONE' },
                    {text: 'התמקדות', value: 'action'},
                    ],
                    desserts: [
                
                    ],
                    expanded: [],
                    tsearch: ""
                }
            },

    
            methods: {


                zoom(name)
                {


                    

                    if (this.radios=='radio-1')
                    {
                        console.log(name);
                        var s_features = kidum_data.filter(function(f) {
                                return f.NAME == name;		
                        });
                        console.log(s_features);
                        if (s_features.length > 0)
                        {
                            console.log( s_features[0]);
                            govmap.zoomToXY({ x: s_features[0].X, y: s_features[0].Y, level: 7, marker: false });
                            appVue.desserts = s_features;
                            appVue.sheet = true;
                        }
                        // govmap.filterLayers({ 'layerName': "LOCALITY_210410", 'whereClause': "CR_LAMAS ='X'", 'zoomToExtent': false});
                    }
                    if (this.radios=='radio-2')
                    {
                        console.log(name);
                        var s_features = setl_data.filter(function(f) {
                                return f.properties.SETL_NAME== name;		
                        });
                        if (s_features.length > 0)
                        {
      
                            var feat = s_features[0];
                            wkt_polygon = feat.geometry;
                            var polygon = new Terraformer.Primitive(wkt_polygon);
                            var results = [];
                            for (ii = 0; ii < kidum_data.length; ii++)
                            {

                                pt_json = {
                                            "type": "Point",
                                            "coordinates": [kidum_data[ii].X, kidum_data[ii].Y]
                                        };

                                var point = new Terraformer.Primitive(pt_json);
                                //console.log(point);
                                if (point.within(polygon))
                                {
                                    results.push(kidum_data[ii]);
                                    console.log(kidum_data[ii]);
                                }
                        
                                
                            }


                            var data = {  
										wkts: [Terraformer.WKT.convert(wkt_polygon)],  
										names: ['p1'],  
										showBubble: true,
										geometryType: govmap.drawType.Polygon,  
										defaultSymbol:  
										{  
											'outlineColor': [0, 0, 255, 1],
											'outlineWidth': 3,
											'fillColor': [255, 255, 255, 0.5]
										},    
										symbols: [],  
										'clearExisting': false,
										data: {  
			
										} 
									}
							govmap.displayGeometries(data).then(function (response)
                            {
                                console.log(response)
                            });
                        
                            x_min  = Terraformer.Tools.calculateEnvelope(wkt_polygon).x
                            y_min = Terraformer.Tools.calculateEnvelope(wkt_polygon).y
                            h = Terraformer.Tools.calculateEnvelope(wkt_polygon).h
                            w = Terraformer.Tools.calculateEnvelope(wkt_polygon).w
                            y_center = y_min + (h/2)
                            x_center = x_min + (w/2)
                            govmap.zoomToXY({ x: x_center, y: y_center, level: 5, marker: false });





                            appVue.desserts = results;
                            appVue.sheet = true;

                        }
                        
                    }
                    if (this.radios=='radio-3')
                    {
                        console.log(name);
                        var s_features = kidum_data.filter(function(f) {
                                return f.LAYER == name;		
                        });
                        console.log(s_features);
                        if (s_features.length > 0)
                        {
                            console.log( s_features[0]);
                            //govmap.zoomToXY({ x: s_features[0].X, y: s_features[0].Y, level: 7, marker: false });
                            appVue.desserts = s_features;
                            appVue.sheet = true;


                            filterLayer(name);
                            
                        }


                        

        
        
                        // govmap.filterLayers({ 'layerName': "LOCALITY_210410", 'whereClause': "CR_LAMAS ='X'", 'zoomToExtent': false});
                    }





 

                },
                SearchSelected(){

                    appVue.desserts = [];
                    tableData = []
                    appVue.desserts = tableData;

                },

                ClearSearch(){



                },

                ClearFilter(){

   


                },

                cancelClick()
                {
                    appVue.desserts = [];
                    tableData = [];
 
                },


                zoomItem(item)
                {
                    console.log(item);
                    var name = item.NAME;
                    govmap.zoomToXY({ x: item.X, y: item.Y, level: 7, marker: false });
                },

                byName()
                {
                  showLayers();
                  console.log("mosad");
                  r = document.getElementById("mosad");
                  r.hidden = false;
                  rm = document.getElementById("mosad_mobile");
                  rm.hidden = false;


                  o = document.getElementById("setl");
                  o.hidden = true;
                  om = document.getElementById("setl_mobile");
                  om.hidden = true;

                                             
                  l = document.getElementById("layer");
                  l.hidden = true;
                  lm = document.getElementById("layer_mobile");
                  lm.hidden = true;
                },

                bySetl(){

                  showLayers();
                  console.log("setl");

                  r = document.getElementById("mosad");
                  r.hidden = true;
                  rm = document.getElementById("mosad_mobile");
                  rm.hidden = true;

                                
                  l = document.getElementById("layer");
                  l.hidden = true;
                  lm = document.getElementById("layer_mobile");
                  lm.hidden = true;


                  o = document.getElementById("setl");
                  o.hidden = false;
                  om = document.getElementById("setl_mobile");
                  om.hidden = false;
                },


                byLayer(){

                    console.log("layer");

                    r = document.getElementById("mosad");
                    r.hidden = true;
                    rm = document.getElementById("mosad_mobile");
                    rm.hidden = true;


                    o = document.getElementById("setl");
                    o.hidden = true;
                    om = document.getElementById("setl_mobile");
                    om.hidden = true;

                    
                    l = document.getElementById("layer");
                    l.hidden = false;
                    lm = document.getElementById("layer_mobile");
                    lm.hidden = false;

                },
                fnExcelReport()
                {



                    var col = [];
                    for (var i = 0; i < this.desserts.length; i++) {
                        for (var key in this.desserts[i]) {
                            if (col.indexOf(key) === -1) {
                                col.push(key);
                            }
                        }
                    }

                    var table = document.createElement("table");

                    var tr = table.insertRow(-1);                   // TABLE ROW.

                    for (var i = 0; i < col.length; i++) {
                        var th = document.createElement("th");      // TABLE HEADER.
                        th.innerHTML = col[i];
                        tr.appendChild(th);
                    }

                    // ADD JSON DATA TO THE TABLE AS ROWS.
                    for (var i = 0; i < this.desserts.length; i++) {

                        tr = table.insertRow(-1);

                        for (var j = 0; j < col.length; j++) {
                            var tabCell = tr.insertCell(-1);
                            tabCell.innerHTML = this.desserts[i][col[j]];
                        }
                    }

                    var tab_text="<table><tr>";
                    var textRange; var j=0;
                    var tab = table;
                    
                    for(j = 0 ; j < tab.rows.length ; j++)
                    {
                        tab_text=tab_text+tab.rows[j].innerHTML+"</tr>";
                        //tab_text=tab_text+"</tr>";
                    }

                    tab_text=tab_text+"</table>";
                    tab_text= tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
                    tab_text= tab_text.replace(/<img[^>]*>/gi,""); // remove if u want images in your table
                    tab_text= tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

                    var ua = window.navigator.userAgent;
                    var msie = ua.indexOf("MSIE ");

                    if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
                    {
                        txtArea1.document.open("txt/html","replace");
                        txtArea1.document.write(tab_text);
                        txtArea1.document.close();
                        txtArea1.focus();
                        sa=txtArea1.document.execCommand("SaveAs",true,"Say Thanks to Sumit.xls");
                    }
                    else                 //other browser not tested on IE 11
                        sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

                    return (sa);
                },
    
    
    
            },
        });
        
        
        </script>
    <body>
    
    
       
    </html>

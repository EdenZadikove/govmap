<!DOCTYPE html>
<html style='width:100%; height:100%;'>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

</style>

<html>


    <head>
        <script src="https://polyfill.io/v3/polyfill.js?features=es5,es6,es7&flags=gated"></script>  
      
        <link rel= 'stylesheet' href= 'https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons'> 
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.govmap.gov.il/govmap/api/govmap.api.js" ></script>


        <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script src="https://polyfill.io/v3/polyfill.js?features=es5,es6,es7&flags=gated"></script>

    </head>

    <body style='width:100%; height:95%;' scrolling='no' dir="rtl">
        <div id="toolbar_app" right >
            <v-app>

                <v-container class="grey lighten-5">

                    <v-card
                    outlined
                    tile
                    >
                        <v-row no-gutters>

                            <v-col
                            cols="12"
                            sm="2"
                            md="2"
                            lg="2"
                            xl="2"               
                            >
                                <v-img max-height="35"  style="text-align: center; margin-top: 15px;" src="https://upload.wikimedia.org/wikipedia/he/e/e8/%D7%94%D7%A8%D7%A9%D7%95%D7%AA_%D7%94%D7%9C%D7%90%D7%95%D7%9E%D7%99%D7%AA_%D7%9C%D7%91%D7%98%D7%99%D7%97%D7%95%D7%AA_%D7%91%D7%93%D7%A8%D7%9B%D7%99%D7%9D.png" aspect-ratio="1.7" contain></v-img>
                            </v-col>

                            <v-col
                                cols="12"
                                sm="8"
                                md="8"
                                lg="8"
                                xl="8"
                            >
                                <h4 style="text-align: center; margin-top: 20px;">{{title}}</h4>
                            </v-col>

                            <v-col
                                cols="12"
                                sm="2"
                                md="2"
                                lg="2"
                                xl="2"
                                >
                                <v-checkbox style="margin-top: 20px;"  v-model="HeatMapSwitch" color="red" :label="heatText" class="font-weight-bold shrink mr-2" elevation=24  @change="Changed()"> </v-checkbox>
                            </v-col>


                        </v-row>
                    </v-card>


    

                    <v-row no-gutters id="menu_row">

                        <v-col
                        cols="12"
                        sm="12"
                        md="12"
                        lg="5"
                        xl="5"
                        >
                            <v-card
                                class="pa-2"
                                outlined
                                tile
                            >
                                <v-select
                                v-model ="RANK"
                                :items="RANK_items"
                                label="חומרת התאונה"
                                multiple
                                flat
                                hide-no-data
                                hide-details
                                append-icon=""
                                :menu-props="{ top: true, offsetY: true }"
                                ></v-select>  
                            </v-card>
                        </v-col>

                        <v-col
                        cols="12"
                        sm="12"
                        md="12"
                        lg="5"
                        xl="5"
                        >
                            <v-card
                            class="pa-2"
                            outlined
                            tile
                            >
                                <v-select
                                v-model = "YEAR"
                                :items="YEAR_items"
                                label="שנה"
                                multiple
                                flat
                                hide-no-data
                                hide-details
                                append-icon=""
                                :menu-props="{ top: true, offsetY: true }"
                                ></v-select>
                            </v-card>
                        </v-col>

                        <v-col
                        cols="12"
                        sm="12"
                        md="12"
                        lg="2"
                        xl="2"
                        >
                            <v-card
                                class="pa-2" style="height: 66px;"
                                outlined
                                tile
                                model= "select_btn"
                            >
                                <v-btn block color="success" dark id="changed_button" style="height: 40px;"  @click="Changed()" >בצע בחירה </v-btn>
                            </v-card>
                        </v-col>
                    </v-row>

                    <v-card
                    outlined
                    tile
                    class="mx-auto"
                    >
                        <div id="map_div" style="padding: 0.5em;
                        background:#4685d1;
                        border: 0;
                        color: white;
                        grid-column: span 2;">

                        </div>
                    </v-card>

                  </v-container>
            </v-app>
        </div>
    </body>


    <script>

        var json_accidents = "https://yovavsanders.github.io/govmap/Accidents.json"
        var accident_features = [];
        var wkts_all = [];
        var names_all = [];
        var bubbleHTMLParameters_all = [];
        var heatmap_features = [];
        var symbols_all = [];


        
        function isInArray(value, array) {
            return array.indexOf(value) > -1;
        }


        function setMapHeight()
        {


            var h = ($(window).height() - $(document.getElementById("menu_row")).height()) / 1.3;
            var isMobile = {
                            Android: function() {
                                return navigator.userAgent.match(/Android/i);
                            },

                            BlackBerry: function() {
                                return navigator.userAgent.match(/BlackBerry/i);
                            },
                            iOS: function() {
                                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
                            },
                            Opera: function() {
                                return navigator.userAgent.match(/Opera Mini/i);
                            },
                            Windows: function() {
                                return navigator.userAgent.match(/IEMobile/i);
                            },
                            any: function() {
                                return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
                            }
                        };
                        if( isMobile.any() ) {

                            h = ($(window).height() - $(document.getElementById("menu_row")).height()) / 1.5
                            this.titleEl = false;
                        } 
                        console.log(h);
                        return h;
        }



       function addLayers(data)
        {
            var xys = [];
            for (i = 0; i < data.length; i++)
            {
                //console.log(i);

                wkts_all.push("POINT(("+data[i].X+" "+data[i].Y+"))");
                names_all.push(data[i].SUB_TYPE);


                bubbleHTMLParameters_all.push(["סוג תאונה: " + data[i].SUB_TYPE + "<br />" + "חומרת תאונה: " + data[i].RANK, "מועד התאונה: " + data[i].MONTH + " " + data[i].YEAR ]);

                // SET HEATMAP!!!
                rad = 10;
                if (data[i].RANK)
                {
                    xys.push(data[i].X+" "+data[i].Y);
                    var count = xys.filter(function(f) {
                        return f == data[i].X+" "+data[i].Y;			
                    }).length;

                    if (data[i].RANK == "קלה")
                    {
                        rad = 10;
                        val1 = 0;
                        val2 = 1 * count;
                        symbols_all.push({  
                            //url:'https://govmap.gov.il/sites/O1.png',  
                            url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Red_circle.svg/200px-Red_circle.svg.png',
                            width:10,  
                            height:10  
                        })
                    }
                    if (data[i].RANK == "קשה")
                    {
                        rad = 20;
                        val1 = 500 * count;
                        val2 =1000 * count;
                        symbols_all.push({  
                            //url:'https://govmap.gov.il/sites/O1.png',  
                            url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Red_circle.svg/200px-Red_circle.svg.png',
                            width:20,  
                            height:20  
                        })
                    }
                    if (data[i].RANK == "קטלנית")
                    {
                        rad = 30;
                        val1 = 1000 * count;
                        val2 = 5000 * count;
                        symbols_all.push({  
                            //url:'https://govmap.gov.il/sites/O1.png',  
                            url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Red_circle.svg/200px-Red_circle.svg.png',
                            width:30,  
                            height:30  
                        })
                    }
                        //val0 = 500;
                }
                else{
                    val1 = 5;
                    val2 = 500;
                    symbols_all.push({  
                            //url:'https://govmap.gov.il/sites/O1.png',  
                            url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Red_circle.svg/200px-Red_circle.svg.png',
                            width:5,  
                            height:5  
                        })
                }
                heatmap_features.push({ point: { x: data[i].X, y:data[i].Y }, attributes: { val1, val2 }, radius:rad});
            }


            if (appVue.HeatMapSwitch == true)
            {
                govmap.setHeatLayer({  
                    points: heatmap_features 
                    ,options: { valueField: 'val1' }  
                }); 
            }
            else
            {
                govmap.removeHeatLayer();
            }


            //Add Points
            data_all = {  
                    wkts: wkts_all,  
                    names: names_all,  
                    geometryType: govmap.drawType.Point,  
                    defaultSymbol:  
                    {  
                        //url:'https://govmap.gov.il/sites/O1.png',  
                        url:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Red_circle.svg/200px-Red_circle.svg.png',
                        width:15,  
                        height:15  
                    },   
                    symbols: symbols_all,  
                    clearExisting: true,  
                    data: {  
                            tooltips: [],  
                            headers: names_all,
                            bubbleHTML: "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div>{0}</div><div>{1}</div><div>{3}</div></div>",
                            bubbleHTMLParameters:bubbleHTMLParameters_all
                        }  
            }; 
            AddUserPoints(data_all);
        }

        function getJsonData(json_accidents){
            $.ajax({
                dataType: 'json',
                beforeSend : function() {;
                },
                success: function(json_data) {
                    {
                        var xys = [];
                        for (i = 0; i < json_data.length; i++)
                        {
                            //console.log(i);
                            accident_features.push(json_data[i]);                          
                        }
                        appVue.Changed();	
                    }

                    console.log("Loaded!")
                },
                error : function(jqXHR, textStatus, errorThrown) {
                    console.log("Error occurred: " + errorThrown);

                },
                url: json_accidents
            });
        }

        function AddUserPoints(data_all)
        {
            govmap.displayGeometries(data_all).then(function (response)  
            {  
                //console.log(response.data);
            });
        }


        function ClearUserPoints(){


            var data = {
							'wkts': ['POINT(130000 700000)'
							],

							'names': ['p1'],
							'geometryType': govmap.drawType.Point,
							'defaultSymbol':
							{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
							},

							'symbols': [{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
								}
							],
							'clearExisting': true,
							'data': {
							'tooltips': ['tooltip1'],
							'bubbles': [''],
							'bubbleUrl': 'https://ynet.co.il'
							}
						};
						govmap.displayGeometries(data).then(function (e)
						{
							//console.log(e.data);
						});

        }

        $(document).ready(function(){
            $(document.getElementById('map_div')).height(setMapHeight);
            //var my_token = "5a4b8472-b95b-4687-8179-0ccb621c7990";//localhost
            //var my_token = "0fff9694-a045-4ede-b997-ee9927b0d56c";//govmap
            var my_token ='aafedfe5-8dfa-4fd5-9af9-8b95759447bd'; // my github
            $(function () {
                    govmap.createMap('map_div', {
                        token: my_token,
                        visibleLayers: ["a"],
                        layers:['NEIGHBORHOODS_AREA', "LOCALITY_210410", "SCHOOL", "KIDS_G"],  
                        showXY: true,
                        identifyOnClick: true,
                        layersMode: 2,
                        level: 5,
                        center: {x: 159000, y: 619000}

                    });
                        
            });

            getJsonData(json_accidents);
        });


        var appVue = new Vue({
            el:"#toolbar_app",
            vuetify: new Vuetify(),
                data () {
                    return {

                        RANK_items: ["קלה", "קשה", "קטלנית"],
                        RANK: ["קשה", "קטלנית"],
                        YEAR_items: [2016, 2017, 2018, 2019, 2020],
                        YEAR: [2019, 2020],
                        title: "נתוני תאונות באשקלון",
                        HeatMapSwitch: false,
                        heatText: "הצג מפת חום",
                        cancel_btn: false,
                        select_btn: true



                    }
                },
                methods: {
                    Cancel()
                    {

                        if (this.HeatMapSwitch == false)
                        {
                            this.heatText = "הצגת מפת חום";
                        }
                        else
                        {
                            govmap.removeHeatLayer();
                            this.heatText = "כיבוי מפת חום";
                        }
                        
                        this.RANK = [];
                        this.YEAR = [];
                        this.HeatMapSwitch = false

                        ClearUserPoints();
                    },

                    Changed()
                    {
                        console.log(this.RANK);
                        console.log(this.YEAR);
                        console.log(this.HeatMapSwitch);
                        if (this.HeatMapSwitch == false)
                        {
                            this.heatText = "הצגת מפת חום";
                        }
                        else
                        {
                            govmap.removeHeatLayer();
                            this.heatText = "כיבוי מפת חום";
                        }

                        wkts_all = [];
                        names_all = [];
                        bubbleHTMLParameters_all = [];
                        heatmap_features= [];
                        symbols_all = [];

                        ClearUserPoints();
                        var accidents = accident_features.filter(function(f) {
                            return (isInArray(f.RANK, appVue.RANK) &&  isInArray(f.YEAR, appVue.YEAR));	
	                    })


                        addLayers(accidents);
                    }

                },
                getImageHeight()
                    {
                        var h = 50;
                        var isMobile = {
                            Android: function() {
                                return navigator.userAgent.match(/Android/i);
                            },

                            BlackBerry: function() {
                                return navigator.userAgent.match(/BlackBerry/i);
                            },
                            iOS: function() {
                                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
                            },
                            Opera: function() {
                                return navigator.userAgent.match(/Opera Mini/i);
                            },
                            Windows: function() {
                                return navigator.userAgent.match(/IEMobile/i);
                            },
                            any: function() {
                                return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
                            }
                        };
                        if( isMobile.any() ) {

                            h = 10
                            this.titleEl = false;
                        } 
                        console.log(h);
                        return h;

                    }
        });
        
    </script>



</html>
